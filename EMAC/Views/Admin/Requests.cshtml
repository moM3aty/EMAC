@model IEnumerable<EMAC.Models.ServiceRequest>

@{
    ViewData["Title"] = "إدارة الطلبات";
    var techniciansList = ViewBag.Technicians as List<SelectListItem>;
}

<div class="container" style="padding-top: 120px; padding-bottom: 50px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1>سجل الطلبات والتحكم في التوزيع</h1>
        <a href="@Url.Action("Dashboard", "Admin")" class="btn secondary-btn">عودة للوحة التحكم</a>
    </div>

    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); overflow-x: auto;">
        <table class="table" style="width: 100%; text-align: right; border-collapse: collapse; min-width: 900px;">
            <thead>
                <tr style="background-color: var(--primary-color); color: white;">
                    <th style="padding: 10px;">رقم الطلب</th>
                    <th style="padding: 10px;">العميل</th>
                    <th style="padding: 10px;">الخدمة / الموعد</th>
                    <th style="padding: 10px;">الفني الحالي</th>
                    <th style="padding: 10px;">إعادة تعيين (تغيير الفني)</th>
                    <th style="padding: 10px;">الحالة</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 15px; font-weight: bold;">@item.RequestNumber</td>
                        <td style="padding: 15px;">
                            @item.CustomerName<br>
                            <span style="color: #888; font-size: 0.9em;">@item.Location</span>
                        </td>
                        <td style="padding: 15px;">
                            @item.ServiceType<br>
                            <span style="color: #E60026; font-size: 0.9em;">@item.AppointmentDate.ToShortDateString() | @item.TimeSlot</span>
                        </td>

                        <td style="padding: 15px;">
                            @if (item.AssignedTechnician != null)
                            {
                                <span style="font-weight: bold; color: var(--primary-color);">@item.AssignedTechnician.FullName</span>
                            }
                            else
                            {
                                <span style="color: red;">غير معين</span>
                            }
                        </td>

                        <td style="padding: 15px;">
                            @if (item.Status != "Completed" && item.Status != "Closed")
                            {
                                <form asp-action="ReassignTechnician" method="post" style="display: flex; gap: 5px;">
                                    <input type="hidden" name="requestId" value="@item.Id" />
                                    <select name="newTechnicianId" class="form-control" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9em; max-width: 150px;">
                                        <option value="">اختر بديلاً...</option>
                                        @foreach (var tech in techniciansList)
                                        {
                                            <option value="@tech.Value">@tech.Text</option>
                                        }
                                    </select>
                                    <button type="submit" class="btn secondary-btn" style="padding: 5px 10px; font-size: 0.8em;">حفظ</button>
                                </form>
                            }
                            else
                            {
                                <span style="color: #aaa;">مغلق</span>
                            }
                        </td>

                        <td style="padding: 15px;">
                            @if (item.Status == "Pending")
                            {
                                <span style="background: orange; color: white; padding: 5px 10px; border-radius: 4px;">معلق</span>
                            }
                            else if (item.Status == "Confirmed")
                            {

                                <span style="background: green; color: white; padding: 5px 10px; border-radius: 4px;">مؤكد</span>
                            }
                            else
                            {

                                <span style="background: #eee; color: #333; padding: 5px 10px; border-radius: 4px;">@item.Status</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>