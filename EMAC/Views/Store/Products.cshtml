@model IEnumerable<EMAC.Models.Product>

@{
    ViewData["Title"] = ViewBag.CategoryName;
    var subCategories = ViewBag.SubCategories as IEnumerable<EMAC.Models.Category>;
    var favIds = ViewBag.FavIds as List<int>;
}

<div class="container" style="padding-top: 120px; padding-bottom: 50px;">

    <div style="margin-bottom: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
            <div>
                <a href="@Url.Action("Index", "Store")" style="color: #666; text-decoration: none;">المتجر</a>
                <span style="margin: 0 10px;">/</span>
                <span style="font-weight: bold; color: var(--primary-color);">@ViewBag.CategoryName</span>
            </div>

            @if (subCategories != null && subCategories.Any())
            {
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <span style="align-self: center; font-weight: bold;">تصفية:</span>
                    @foreach (var sub in subCategories)
                    {
                        <a href="@Url.Action("Products", "Store", new { categoryId = sub.Id })" class="btn secondary-btn" style="padding: 5px 15px; font-size: 0.9em;">@sub.Name</a>
                    }
                </div>
            }
        </div>
    </div>

    @if (!Model.Any())
    {
        <div style="text-align: center; padding: 50px; background: white; border-radius: 10px;">
            <i class="fas fa-box-open fa-3x" style="color: #ddd; margin-bottom: 20px;"></i>
            <h3>لا توجد منتجات في هذا القسم حالياً</h3>
            <a href="@Url.Action("Index", "Store")" class="btn primary-btn mt-3">العودة للأقسام</a>
        </div>
    }
    else
    {
        <div class="all-products-grid" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
            @foreach (var product in Model)
            {
                bool isFav = favIds != null && favIds.Contains(product.Id);

                <div class="product-card" style="background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; position: relative; transition: transform 0.3s; border: 1px solid #eee;">

                    @if (product.DiscountPercentage > 0)
                    {
                        <span style="position: absolute; top: 10px; right: 10px; background-color: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;">
                            -@product.DiscountPercentage%
                        </span>
                    }

                    <span onclick="toggleFav(this, @product.Id)"
                          style="position: absolute; top: 10px; left: 10px; background: #fff; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; color: @(isFav ? "#e60026" : "#666");">
                        <i class="@(isFav ? "fas" : "far") fa-heart"></i>
                    </span>

                    <a href="@Url.Action("Details", "Store", new { id = product.Id })" style="display: block; text-decoration: none;">
                        <div style="height: 200px; display: flex; align-items: center; justify-content: center; padding: 20px; background: #fff;">
                            <img src="~/images/products/@(string.IsNullOrEmpty(product.ImageUrl) ? "default.png" : product.ImageUrl)"
                                 onerror="this.src='https://via.placeholder.com/200?text=Product'"
                                 alt="@product.Name"
                                 style="max-height: 100%; max-width: 100%; object-fit: contain;">
                        </div>

                        <div style="padding: 15px;">
                            <div style="background: #e9ecef; display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; color: #495057; margin-bottom: 5px;">
                                @product.Brand
                            </div>

                            <h3 style="font-size: 1em; color: #333; margin: 5px 0 10px 0; height: 40px; overflow: hidden; line-height: 1.4;">
                                @product.Name, @product.SizeOrCapacity
                            </h3>

                            <div style="display: flex; align-items: baseline; gap: 10px; flex-wrap: wrap;">
                                <span style="font-size: 1.2em; font-weight: bold; color: #333;">@product.Price.ToString("N0") <small style="font-size: 0.7em;">ر.س</small></span>
                                @if (product.OldPrice.HasValue && product.OldPrice > product.Price)
                                {
                                    <span style="text-decoration: line-through; color: #999; font-size: 0.9em;">@product.OldPrice.Value.ToString("N0")</span>
                                }
                            </div>
                        </div>
                    </a>

                    <div style="padding: 0 15px 15px 15px;">
                        @{
                            string msg = $"مرحباً، أرغب في طلب المنتج: {product.Name} (السعر: {product.Price} ر.س)";
                            string waLink = $"https://wa.me/966564133825?text={System.Net.WebUtility.UrlEncode(msg)}";
                        }
                        <a href="@waLink" target="_blank" class="btn primary-btn" style="width: 100%; display: block; text-align: center; background-color: #8bc34a; border: none; font-size: 0.95em;">
                            <i class="fab fa-whatsapp"></i> اطلبه الآن واتساب
                        </a>
                    </div>
                </div>
            }
        </div>
    }
</div>

<script>
    async function toggleFav(element, id) {
        try {
            const response = await fetch('/Store/ToggleFavorite?id=' + id, { method: 'POST' });
            const data = await response.json();

            if (data.success) {
                const icon = element.querySelector('i');
                if (data.isAdded) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    element.style.color = '#e60026'; 
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    element.style.color = '#666'; 
                }

                const badge = document.getElementById('fav-count');
                if(badge) {
                    badge.textContent = data.count;
                    badge.style.display = data.count > 0 ? 'flex' : 'none';
                }
            }
        } catch (e) {
            console.error(e);
        }
    }
</script>